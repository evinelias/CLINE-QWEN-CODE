name: Build and Release CLINE-QWEN-CODE

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@evinelias'

      - name: Install dependencies
        run: |
          npm ci --no-audit --no-fund
          cd webview-ui && npm ci --no-audit --no-fund

      - name: Build webview
        run: npm run build:webview

      - name: Build extension
        run: npm run package

      - name: Install VSCE and create VSIX
        run: |
          npm install -g @vscode/vsce
          
      - name: Get package info
        id: package
        run: |
          echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT
          echo "name=CLINE-QWEN-CODE" >> $GITHUB_OUTPUT

      - name: Create versioned VSIX packages
        run: |
          # Create main VSIX package
          vsce package --out CLINE-QWEN-CODE-v${{ steps.package.outputs.version }}.vsix --no-dependencies
          
          # Create generic name for compatibility
          cp CLINE-QWEN-CODE-v${{ steps.package.outputs.version }}.vsix CLINE-QWEN-CODE.vsix

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: CLINE-QWEN-CODE-Extension-v${{ steps.package.outputs.version }}
          path: |
            CLINE-QWEN-CODE-v${{ steps.package.outputs.version }}.vsix
            CLINE-QWEN-CODE.vsix
          retention-days: 90

      - name: Create GitHub Release with Downloadable VSIX
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            CLINE-QWEN-CODE-v${{ steps.package.outputs.version }}.vsix
            CLINE-QWEN-CODE.vsix
          draft: false
          prerelease: false
          name: "🚀 CLINE-QWEN-CODE v${{ steps.package.outputs.version }}"
          body: |
            ## 🤖 Cline AI Assistant with Qwen Code API Integration
            
            **Enhanced VS Code extension** with Qwen Code API support for advanced AI-powered coding assistance.
            
            ### 📥 **Quick Download & Install**
            
            1. **Download**: Click on `CLINE-QWEN-CODE-v${{ steps.package.outputs.version }}.vsix` below ⬇️
            2. **Install**: Open VS Code → Extensions → Install from VSIX → Select downloaded file
            3. **Configure**: Add your Qwen API key in Cline settings
            4. **Code**: Start using enhanced AI assistance!
            
            ### ✨ **What's New in This Release**
            
            - 🧠 **Qwen Code Integration**: Specialized AI models optimized for coding tasks
            - 🔄 **Multi-Provider Support**: Switch between Qwen, Claude, GPT-4, Gemini
            - 🌐 **40+ Languages**: Enhanced code generation and analysis
            - 🖥️ **Terminal Integration**: AI monitors and assists with command execution
            - 🌐 **Browser Automation**: Web testing and debugging capabilities
            - 🔧 **MCP Protocol**: Extensible via Model Context Protocol
            
            ### 📊 **Package Details**
            
            | Property | Value |
            |----------|-------|
            | **File Size** | ~8.5 MB |
            | **VS Code Version** | 1.84.0+ |
            | **Installation** | Direct VSIX install |
            | **License** | Apache 2.0 |
            
            ### 💡 **Alternative Installation Methods**
            
            ```bash
            # Command line installation
            code --install-extension CLINE-QWEN-CODE-v${{ steps.package.outputs.version }}.vsix
            
            # Or download and install manually
            curl -L https://github.com/evinelias/CLINE-QWEN-CODE/releases/download/v${{ steps.package.outputs.version }}/CLINE-QWEN-CODE-v${{ steps.package.outputs.version }}.vsix -o cline-qwen.vsix
            code --install-extension cline-qwen.vsix
            ```
            
            ### 🔗 **Links**
            
            - 📚 [Documentation](https://github.com/evinelias/CLINE-QWEN-CODE/blob/main/README.md)
            - 🐛 [Report Issues](https://github.com/evinelias/CLINE-QWEN-CODE/issues)
            - 💬 [Discussions](https://github.com/evinelias/CLINE-QWEN-CODE/discussions)
            
            ---
            
            **Ready to supercharge your coding with AI? Download the VSIX file above! 🚀**
          generate_release_notes: false
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}